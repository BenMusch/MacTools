#!/usr/bin/env ruby
require 'json'
require 'yaml'
require 'fileutils'
require 'pathname'

USER_HOME = ENV['HOME']
DROPBOX_BASE = USER_HOME + '/Dropbox'

# # # # # # # # # # # # # # # # # # #
# Utility functions
# # # # # # # # # # # # # # # # # # #

# Prompt text and other modes:
# :nl - Add a newline before prompt
def ask(text, *mode)
  extra=''
  extra = "\n" if mode.include?(:nl)
  print "#{text}#{extra}"
  gets.strip
end

# Prompt to ask if we want to continue
def continue?
  print "Continue? [yN]: "
  exit 1 if gets.strip != 'y'
end

# # # # # # # # # # # # # # # # # # #
# Path functions
# # # # # # # # # # # # # # # # # # #

# Home path
def h(*paths)
  ([USER_HOME] + paths).join('/')
end

# Dropbox path
def d(*paths)
  ([DROPBOX_BASE] + paths).join('/')
end

def find(path)
  return path if File.exist? path
  return h(path) if File.exist? h(path)
end

def status(path)
end

def try(path, notexist = nil)
  file = nil
  to_raise = false

  if !File.exist? path
    case notexist
    when :create ;  file = File.new(path, 'w+')
    when :null   ;  file = nil
    when :ignore ;  return
    end
  else
    file = File.open(path, 'r+')
  end

  raise "File #{path} does not exist" if to_raise
  yield(file) if !to_raise
  file.close if file
end

# # # # # # # # # # # # # # # # # # #
# Main section
# # # # # # # # # # # # # # # # # # #

try h('.dropsync'), :create do |file|
  config = YAML.load(file.read)
  config.each do |path|
    puts find(path)
  end
end
